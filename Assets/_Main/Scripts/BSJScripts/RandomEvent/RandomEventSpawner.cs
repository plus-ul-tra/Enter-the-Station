using UnityEngine;
using System.Collections.Generic;
using System.Threading;

public class RandomEventSpawner : MonoBehaviour
{
    [Header("매니저")]
    public StageManager stageManager;                   // 스테이지 매니저
    public TaskManager taskManager;                     // 미니게임 실행 매니저

    [Header("화살표, 무전기")]
    public EventDirectionArrow eventDirectionArrow;     // 이벤트 화살표
    public SpeechBubble speechBubble;                   // 무전기 말풍선

    [Header("돌발상황 오브젝트")]
    public List<RandomEventObject> randomEventList;     // 랜덤 돌발상황 업스케일 관리 리스트
    public List<RandomEventObject> createdEventList;    // 생성된 돌발상황 관리 리스트

    [Header("돌발상황 발생 주기(시간)")]
    [SerializeField]
    private float eventSpawnTime = 16f;
    private float currentSpawnTimer = 0f;               // 현재 스폰 시간

    private void Start()
    {
        // 테스트 : 시작할 때 몇 초 후에 돌발상황 발생할 것인지?
        currentSpawnTimer = 10f;
    }

    private void Update()
    {
        // 돌발상황 발생 주기 마다 이벤트 생성
        currentSpawnTimer += Time.deltaTime;

        if (currentSpawnTimer >= eventSpawnTime)
        {
            currentSpawnTimer -= eventSpawnTime;

            // TODO : 테스트용 랜덤 스폰 나중에 변경해야함.
            // 맵 크기 테스트용
            Vector3 randomPosition = new Vector3(Random.Range(-10, 7), Random.Range(-4.5f, -1f), 0);
            CreateRandomEventObject(randomPosition);
        }
    }

    /// <summary>
    /// 랜덤 오브젝트를 생성하는 함수
    /// </summary>
    /// <param name="eventPosition"></param>
    public void CreateRandomEventObject(Vector3 eventPosition)
    {
        if (stageManager.playerCurHp <= 0) return;

        int randomIndex = Random.Range(0, randomEventList.Count);

        GameObject eventObject = Instantiate(randomEventList[randomIndex].gameObject, eventPosition, Quaternion.identity);
        if(eventObject.TryGetComponent<RandomEventObject>(out RandomEventObject randomEvent))
        {
            createdEventList.Add(randomEvent);

            // 콜백 (상호작용 성공 / 실패) 등록
            randomEvent.onEventSuccess += OnRandomEventSuccess;
            randomEvent.onEventFailed += OnRandomEventInteractFailed;

            // 미니게임 생성용 참조
            randomEvent.ReferTaskManager(taskManager);

            // 화살표 생성
            eventDirectionArrow.CreateArrow(randomEvent);

            // 말풍선 생성
            speechBubble.PlaySpeechBubble();
        }
    }

    // 랜덤 돌발상황 상호작용 성공 감지
    private void OnRandomEventSuccess(RandomEventObject successEvent)
    {
        Debug.Log("이벤트 상호작용 성공 감지 : " + successEvent.name);

        // 이벤트 해제 (누수 방지)
        successEvent.onEventSuccess -= OnRandomEventSuccess;
        successEvent.onEventFailed -= OnRandomEventInteractFailed;

        createdEventList.Remove(successEvent);
        eventDirectionArrow.RemoveArrow(successEvent);
        Destroy(successEvent.gameObject);
    }

    // 랜덤 돌발상황 상호작용 실패 감지
    private void OnRandomEventInteractFailed(RandomEventObject failedEvent)
    {
        Debug.Log("이벤트 상호작용 실패 감지 : " + failedEvent.name);

        // 이벤트 해제 (누수 방지)
        failedEvent.onEventSuccess -= OnRandomEventSuccess;
        failedEvent.onEventFailed -= OnRandomEventInteractFailed;

        stageManager.DecreasePlayerHp();                // 플레이어 Hp 감소
        createdEventList.Remove(failedEvent);           // 생성된 돌발상황 오브젝트 삭제
        eventDirectionArrow.RemoveArrow(failedEvent);   // 추적하는 화살표 삭제
        Destroy(failedEvent.gameObject);                // 오브젝트 파괴
    }
}
